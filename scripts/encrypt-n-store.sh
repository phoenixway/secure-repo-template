#!/bin/bash
set -e

# –í–∏–∑–Ω–∞—á–∞—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞ —Ç–∞ –∫–æ—Ä—ñ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_DIR" # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ –º–∏ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

echo "[üöÄ] –ó–∞–ø—É—Å–∫ –ø–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª—É —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è..."
echo "======================================================================"

# --- –ï—Ç–∞–ø 1: –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ ---
echo "[ 1/4 ] –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö .md —Ñ–∞–π–ª—ñ–≤..."
if bash "$SCRIPT_DIR/encrypt-unencrypted.sh"; then
  echo "[‚úÖ] –ï—Ç–∞–ø 1: –õ–æ–∫–∞–ª—å–Ω—ñ —Ñ–∞–π–ª–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ (–∞–±–æ –≤–∂–µ –±—É–ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ)."
else
  echo "[‚ùå] –ï—Ç–∞–ø 1: –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤. –ü–µ—Ä–µ—Ä–∏–≤–∞—é."
  exit 1
fi
echo "----------------------------------------------------------------------"

# --- –ï—Ç–∞–ø 2: –†–æ–±–æ—Ç–∞ –∑ Git: –∫–æ–º—ñ—Ç ---
echo "[ 2/4 ] –†–æ–±–æ—Ç–∞ –∑ Git: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω —Ç–∞ –∫–æ–º—ñ—Ç..."
# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –∑–º—ñ–Ω–∏ –¥–ª—è –∫–æ–º—ñ—Ç—É (—Ç—ñ–ª—å–∫–∏ *.md.age —Ç–∞ README.md)
# git status --porcelain –ø–æ–≤–µ—Ä–Ω–µ —Å–ø–∏—Å–æ–∫ –∑–º—ñ–Ω–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤.
# –ú–∏ —à—É–∫–∞—î–º–æ *.md.age –∞–±–æ README.md
CHANGES_TO_COMMIT=$(git status --porcelain README.md *.md.age 2>/dev/null)

if [[ -n "$CHANGES_TO_COMMIT" ]]; then
  echo "[üì¶] Git: –Ñ –∑–º—ñ–Ω–∏ –¥–ª—è –∫–æ–º—ñ—Ç—É:"
  echo "$CHANGES_TO_COMMIT" # –ü–æ–∫–∞–∑—É—î–º–æ, —â–æ –±—É–¥–µ –∑–∞–∫–æ–º–º—ñ—á–µ–Ω–æ
  git add README.md *.md.age # –î–æ–¥–∞—î–º–æ README.md –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –∑–º—ñ–Ω —Ç–∞ –≤—Å—ñ .md.age
  
  COMMIT_MESSAGE="–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö $(date +'%Y-%m-%d %H:%M:%S')"
  echo "[üí¨] Git: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º—ñ—Ç—É –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º: '$COMMIT_MESSAGE'..."
  if git commit -m "$COMMIT_MESSAGE"; then
    echo "[‚úÖ] –ï—Ç–∞–ø 2: Git –∫–æ–º—ñ—Ç —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ."
  else
    echo "[‚ö†Ô∏è] –ï—Ç–∞–ø 2: Git: –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º—ñ—Ç—É. –ú–æ–∂–ª–∏–≤–æ, –Ω–µ –±—É–ª–æ —á–æ–≥–æ –∫–æ–º—ñ—Ç–∏—Ç–∏ –ø—ñ—Å–ª—è add?"
    # –ù–µ –≤–∏—Ö–æ–¥–∏–º–æ, –º–æ–∂–µ–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ push, —è–∫—â–æ –∫–æ–º—ñ—Ç –±—É–≤ —Ä–∞–Ω—ñ—à–µ, –∞–ª–µ –Ω–µ –∑–∞–ø—É—à–µ–Ω–æ
  fi
else
  echo "[‚ÑπÔ∏è] –ï—Ç–∞–ø 2: Git: –ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–º—ñ–Ω —É —Ñ–∞–π–ª–∞—Ö README.md –∞–±–æ *.md.age –¥–ª—è –∫–æ–º—ñ—Ç—É."
fi
echo "----------------------------------------------------------------------"

# --- –ï—Ç–∞–ø 3: –†–æ–±–æ—Ç–∞ –∑ Git: push ---
echo "[ 3/4 ] –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–º Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—î–º (push)..."
# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π remote 'origin'
if git remote | grep -q '^origin$'; then
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
  echo "[üöÄ] Git: –°–ø—Ä–æ–±–∞ push –Ω–∞ 'origin $CURRENT_BRANCH'..."
  if git push origin "$CURRENT_BRANCH"; then
    echo "[‚úÖ] –ï—Ç–∞–ø 3: Git: –ó–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π."
  else
    echo "[‚ö†Ô∏è] –ï—Ç–∞–ø 3: Git: –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å push. –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:"
    echo "    - –ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∫–æ–º—ñ—Ç—ñ–≤ –¥–ª—è push (–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è 'Everything up-to-date')."
    echo "    - –ü—Ä–æ–±–ª–µ–º–∏ –∑ –º–µ—Ä–µ–∂–µ—é –∞–±–æ –¥–æ—Å—Ç—É–ø–æ–º –¥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é."
    echo "    - –ü–æ—Ç—Ä—ñ–±–Ω–æ —Å–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±–∏—Ç–∏ 'git pull', —è–∫—â–æ —î —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ."
    # –ù–µ –≤–≤–∞–∂–∞—î–º–æ —Ü–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—é –ø–æ–º–∏–ª–∫–æ—é –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –¥–æ –±–µ–∫–∞–ø—É, —è–∫—â–æ —Ü–µ –Ω–µ "fatal"
  fi
else
  echo "[‚ÑπÔ∏è] –ï—Ç–∞–ø 3: Git: –í—ñ–¥–¥–∞–ª–µ–Ω–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π 'origin' –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ. –ü—Ä–æ–ø—É—Å–∫–∞—é git push."
fi
echo "----------------------------------------------------------------------"

# --- –ï—Ç–∞–ø 4: –•–º–∞—Ä–Ω–∏–π –±–µ–∫–∞–ø ---
echo "[ 4/4 ] –ó–∞–ø—É—Å–∫ —Ö–º–∞—Ä–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è..."
CONFIG_LOADED=false
CLOUD_REMOTES_CONFIG=""
if [ -f ".env" ]; then
  CLOUD_REMOTES_CONFIG=$(grep '^CLOUD_REMOTES=' .env | cut -d'=' -f2 | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
  CONFIG_LOADED=true
fi

if ! $CONFIG_LOADED || [ -z "$CLOUD_REMOTES_CONFIG" ]; then
  echo "[‚ÑπÔ∏è] –ï—Ç–∞–ø 4: –•–º–∞—Ä–Ω—ñ —Å—Ö–æ–≤–∏—â–∞ (CLOUD_REMOTES –≤ .env) –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –∞–±–æ .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."
  echo "[‚òÅÔ∏è] –ü—Ä–æ–ø—É—Å–∫–∞—é –∫—Ä–æ–∫ —Ö–º–∞—Ä–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è."
else
  echo "[‚òÅÔ∏è] –í–∏–∫–æ–Ω—É—é push-to-clouds.sh –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∫–∞–ø—É..."
  if bash "$SCRIPT_DIR/push-to-clouds.sh"; then
    echo "[‚úÖ] –ï—Ç–∞–ø 4: –•–º–∞—Ä–Ω–µ —Ä–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–∞–±–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ, —è–∫—â–æ –Ω–µ –±—É–ª–æ —á–æ–≥–æ –±–µ–∫–∞–ø–∏—Ç–∏)."
  else
    echo "[‚ùå] –ï—Ç–∞–ø 4: –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —Ö–º–∞—Ä–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è."
    echo "[‚ö†Ô∏è] –õ–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ —Ç–∞ (–º–æ–∂–ª–∏–≤–æ) –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Git, –∞–ª–µ —Ö–º–∞—Ä–Ω–∏–π –±–µ–∫–∞–ø –Ω–µ –≤–¥–∞–≤—Å—è."
    # –ù–µ –≤–∏—Ö–æ–¥–∏–º–æ –∑ –ø–æ–º–∏–ª–∫–æ—é –∑ encrypt-n-store, –±–æ –æ—Å–Ω–æ–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –º–æ–≥–ª–∞ –ø—Ä–æ–π—Ç–∏
  fi
fi
echo "======================================================================"
echo "[üèÅ] –ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ."