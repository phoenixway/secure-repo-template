#!/bin/bash
set -e

# –í–∏–∑–Ω–∞—á–∞—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞ —Ç–∞ –∫–æ—Ä—ñ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_DIR" # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ –º–∏ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, —è–∫—â–æ —î .env
if [ -f ".env" ]; then
  # –ß–∏—Ç–∞—î–º–æ –∑–º—ñ–Ω–Ω—ñ –±–µ–∑–ø–µ—á–Ω–æ
  AGE_RECIPIENT=$(grep '^AGE_RECIPIENT=' .env | cut -d'=' -f2 | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
else
  echo "[‚ùå] –§–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é ($REPO_DIR)."
  echo "[‚ÑπÔ∏è] –ë—É–¥—å –ª–∞—Å–∫–∞, —Å—Ç–≤–æ—Ä—ñ—Ç—å .env –∑ .env.example —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –π–æ–≥–æ."
  exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞
if [ -z "$AGE_RECIPIENT" ]; then
  echo "[‚ùå] –ó–º—ñ–Ω–Ω–∞ AGE_RECIPIENT –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ —É —Ñ–∞–π–ª—ñ .env –∞–±–æ –ø–æ—Ä–æ–∂–Ω—è."
  echo "[‚ÑπÔ∏è] –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å AGE_RECIPIENT —É —Ñ–∞–π–ª—ñ .env."
  echo "    –ô–æ–≥–æ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ –≤–∞—à–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –∫–æ–º–∞–Ω–¥–æ—é: age-keygen -y /—à–ª—è—Ö/–¥–æ/–≤–∞—à–æ–≥–æ/age-key.txt"
  echo "    –ê–±–æ, —è–∫—â–æ –∫–ª—é—á GPG-–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π: gpg -d /—à–ª—è—Ö/–¥–æ/–∫–ª—é—á–∞.gpg | age-keygen -y -"
  exit 1
fi

echo "[‚ÑπÔ∏è] –ü–æ—à—É–∫ –Ω–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö .md —Ñ–∞–π–ª—ñ–≤ –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è (–∫—Ä—ñ–º README.md)..."
FILES_ENCRYPTED_COUNT=0
FILES_SKIPPED_COUNT=0
FILES_ALREADY_ENCRYPTED_COUNT=0
FILES_FAILED_ENCRYPTION_COUNT=0
FILES_FAILED_SHRED_COUNT=0

# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ find –¥–ª—è –∫—Ä–∞—â–æ—ó –æ–±—Ä–æ–±–∫–∏ —ñ–º–µ–Ω —Ñ–∞–π–ª—ñ–≤ –∑ –ø—Ä–æ–±—ñ–ª–∞–º–∏ —Ç–æ—â–æ.
# –Ü–≥–Ω–æ—Ä—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, —è–∫—â–æ –≤–æ–Ω–∏ –≤–∏–ø–∞–¥–∫–æ–≤–æ –º–∞—é—Ç—å .md —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è.
find . -maxdepth 1 -type f -name "*.md" -print0 | while IFS= read -r -d $'\0' FILE_PATH_RAW; do
  # –û–±—Ä–æ–±–∫–∞ —à–ª—è—Ö—É, —è–∫—â–æ find –ø–æ–≤–µ—Ä—Ç–∞—î ./file.md
  FILE_PATH="${FILE_PATH_RAW#./}"
  BASENAME_FILE=$(basename "$FILE_PATH")

  if [[ "$BASENAME_FILE" == "README.md" ]]; then
    echo "[‚è≠Ô∏è] –ü—Ä–æ–ø—É—Å–∫–∞—é $BASENAME_FILE (—Ñ–∞–π–ª README)"
    ((FILES_SKIPPED_COUNT++))
    continue
  fi

  AGEFILE="$BASENAME_FILE.age" # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª –±—É–¥–µ –≤ –∫–æ—Ä–µ–Ω—ñ

  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –≤–∂–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª
  if [[ -f "$AGEFILE" ]]; then
    # –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª –Ω–æ–≤—ñ—à–∏–π –∑–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π, –π–æ–≥–æ —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ—à–∏—Ñ—Ä—É–≤–∞—Ç–∏
    if [[ "$FILE_PATH" -nt "$AGEFILE" ]]; then
      echo "[‚ö†Ô∏è] –§–∞–π–ª $BASENAME_FILE –Ω–æ–≤—ñ—à–∏–π –∑–∞ $AGEFILE. –ü–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤—É—é."
      # –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –¥–æ –±–ª–æ–∫—É —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è
    else
      echo "[‚úÖ] –ü—Ä–æ–ø—É—Å–∫–∞—é $BASENAME_FILE ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π $AGEFILE —ñ—Å–Ω—É—î —ñ –Ω–µ —Å—Ç–∞—Ä—ñ—à–∏–π."
      ((FILES_ALREADY_ENCRYPTED_COUNT++))
      # –Ø–∫—â–æ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª —ñ—Å–Ω—É—î —ñ –Ω–µ –Ω–æ–≤—ñ—à–∏–π –∑–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π,
      # –π–æ–≥–æ —Å–ª—ñ–¥ –±–µ–∑–ø–µ—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏, —â–æ–± –Ω–µ –∑–∞–ª–∏—à–∞—Ç–∏ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö.
      # –¶–µ –æ—Å–æ–±–ª–∏–≤–æ –≤–∞–∂–ª–∏–≤–æ, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏–≤ encrypt-unencrypted.sh,
      # –∞ –Ω–µ encrypt-n-store.sh, —è–∫–∏–π –±–∏ —ñ —Ç–∞–∫ –≤–∏–¥–∞–ª–∏–≤.
      echo "[üóëÔ∏è] –†–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —Ñ–∞–π–ª '$BASENAME_FILE' —ñ—Å–Ω—É—î –ø–æ—Ä—É—á —ñ–∑ –∞–∫—Ç—É–∞–ª—å–Ω–∏–º '$AGEFILE'. –í–∏–¥–∞–ª—è—é –æ—Ä–∏–≥—ñ–Ω–∞–ª..."
      if shred -u "$FILE_PATH"; then
        echo "[‚úÖ] –û—Ä–∏–≥—ñ–Ω–∞–ª '$BASENAME_FILE' —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ."
      else
        echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤–∏–¥–∞–ª–µ–Ω–Ω—è '$FILE_PATH' –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é shred! –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–¥–∞–ª—ñ—Ç—å –π–æ–≥–æ –≤—Ä—É—á–Ω—É —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ."
        ((FILES_FAILED_SHRED_COUNT++))
      fi
      continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ñ–∞–π–ª—É
    fi
  fi

  echo "[üîê] –®–∏—Ñ—Ä—É—é $BASENAME_FILE ‚Üí $AGEFILE..."
  if age -r "$AGE_RECIPIENT" -o "$AGEFILE" "$FILE_PATH"; then
    echo "[üóëÔ∏è] –ë–µ–∑–ø–µ—á–Ω–æ –≤–∏–¥–∞–ª—è—é –æ—Ä–∏–≥—ñ–Ω–∞–ª $BASENAME_FILE..."
    if shred -u "$FILE_PATH"; then
      echo "[‚úÖ] –§–∞–π–ª $BASENAME_FILE —É—Å–ø—ñ—à–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ —Ç–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª –≤–∏–¥–∞–ª–µ–Ω–æ."
      ((FILES_ENCRYPTED_COUNT++))
    else
      echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤–∏–¥–∞–ª–µ–Ω–Ω—è $FILE_PATH –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é shred! –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–¥–∞–ª—ñ—Ç—å –π–æ–≥–æ –≤—Ä—É—á–Ω—É —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ."
      ((FILES_FAILED_SHRED_COUNT++))
      # –§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –∞–ª–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª –Ω–µ –≤–∏–¥–∞–ª–µ–Ω–æ - —Ü–µ –ø—Ä–æ–±–ª–µ–º–∞.
      # –ú–æ–∂–ª–∏–≤–æ, –≤–∞—Ä—Ç–æ –∑—É–ø–∏–Ω–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç —Ç—É—Ç –∞–±–æ –¥–æ–¥–∞—Ç–∏ –≤ –æ–∫—Ä–µ–º–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–æ–∫.
    fi
  else
    echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è $BASENAME_FILE! –û—Ä–∏–≥—ñ–Ω–∞–ª –Ω–µ –≤–∏–¥–∞–ª–µ–Ω–æ."
    ((FILES_FAILED_ENCRYPTION_COUNT++))
  fi
done

echo ""
echo "[üìä] –ó–≤—ñ—Ç –ø–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—é:"
echo "    –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤–∏—Ö/–æ–Ω–æ–≤–ª–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤: $FILES_ENCRYPTED_COUNT"
echo "    –ü—Ä–æ–ø—É—â–µ–Ω–æ (README.md): $FILES_SKIPPED_COUNT"
echo "    –í–∂–µ –±—É–ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ (—ñ –∞–∫—Ç—É–∞–ª—å–Ω—ñ): $FILES_ALREADY_ENCRYPTED_COUNT"
if [ $FILES_FAILED_ENCRYPTION_COUNT -gt 0 ]; then
    echo "    [‚ùó] –ü–æ–º–∏–ª–æ–∫ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è: $FILES_FAILED_ENCRYPTION_COUNT"
fi
if [ $FILES_FAILED_SHRED_COUNT -gt 0 ]; then
    echo "    [‚ùó] –ü–æ–º–∏–ª–æ–∫ –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ–≤: $FILES_FAILED_SHRED_COUNT"
fi

if [ $FILES_FAILED_ENCRYPTION_COUNT -eq 0 ] && [ $FILES_FAILED_SHRED_COUNT -eq 0 ]; then
  echo "[üëç] –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö .md —Ñ–∞–π–ª—ñ–≤ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
else
  echo "[‚ö†Ô∏è] –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥ –≤–∏—â–µ."
  exit 1 # –í–∏—Ö–æ–¥–∏–º–æ –∑ –ø–æ–º–∏–ª–∫–æ—é, —è–∫—â–æ –±—É–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏
fi