#!/bin/bash
set -e

# –í–∏–∑–Ω–∞—á–∞—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Å–∫—Ä–∏–ø—Ç–∞ —Ç–∞ –∫–æ—Ä—ñ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_DIR" # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ –º–∏ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, —è–∫—â–æ —î .env
if [ -f ".env" ]; then
  # –ß–∏—Ç–∞—î–º–æ –∑–º—ñ–Ω–Ω—ñ –±–µ–∑–ø–µ—á–Ω–æ
  AGE_RECIPIENT=$(grep '^AGE_RECIPIENT=' .env | cut -d'=' -f2 | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
  CLOUD_REMOTES=$(grep '^CLOUD_REMOTES=' .env | cut -d'=' -f2 | sed 's/^"//;s/"$//;s/^'\''//;s/'\''$//')
else
  echo "[‚ùå] –§–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é ($REPO_DIR)."
  echo "[‚ÑπÔ∏è] –ë—É–¥—å –ª–∞—Å–∫–∞, —Å—Ç–≤–æ—Ä—ñ—Ç—å .env –∑ .env.example —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –π–æ–≥–æ."
  exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞
if [ -z "$AGE_RECIPIENT" ]; then
  echo "[‚ùå] –ó–º—ñ–Ω–Ω–∞ AGE_RECIPIENT –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ —É —Ñ–∞–π–ª—ñ .env –∞–±–æ –ø–æ—Ä–æ–∂–Ω—è."
  echo "[‚ÑπÔ∏è] –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å AGE_RECIPIENT —É —Ñ–∞–π–ª—ñ .env."
  exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ rclone
if ! command -v rclone &> /dev/null; then
    echo "[‚ùå] –ö–æ–º–∞–Ω–¥—É rclone –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å rclone —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –≤–∞—à—ñ —Ö–º–∞—Ä–Ω—ñ —Å—Ö–æ–≤–∏—â–∞."
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –≤–∏–∑–Ω–∞—á–µ–Ω–æ CLOUD_REMOTES
if [ -z "$CLOUD_REMOTES" ]; then
  echo "[‚ÑπÔ∏è] –ó–º—ñ–Ω–Ω–∞ CLOUD_REMOTES –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞ –∞–±–æ –ø–æ—Ä–æ–∂–Ω—è —É —Ñ–∞–π–ª—ñ .env."
  echo "[‚òÅÔ∏è] –•–º–∞—Ä–Ω–µ —Ä–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –±—É–¥–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ."
  exit 0 # –í–∏—Ö–æ–¥–∏–º–æ –±–µ–∑ –ø–æ–º–∏–ª–∫–∏, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è
fi

BACKUP_SUBDIR="backup" # –ü—ñ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∞—Ä—Ö—ñ–≤—ñ–≤ —É –∫–æ—Ä–µ–Ω—ñ —Ä–µ–ø–æ
mkdir -p "$BACKUP_SUBDIR"

DATE_SUFFIX=$(date +"%Y-%m-%d-%H%M%S") # –î–æ–¥–∞–≤ —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è –±—ñ–ª—å—à–æ—ó —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
ARCHIVE_BASENAME="secure-repo-backup-$DATE_SUFFIX"
LOCAL_TAR_ARCHIVE_PATH="$BACKUP_SUBDIR/$ARCHIVE_BASENAME.tar.gz"
LOCAL_ENCRYPTED_ARCHIVE_PATH="$BACKUP_SUBDIR/$ARCHIVE_BASENAME.tar.gz.age"

echo "[üì¶] –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è..."
FILES_TO_ARCHIVE=()
# –î–æ–¥–∞—î–º–æ README.md, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
[ -f "README.md" ] && FILES_TO_ARCHIVE+=("README.md")

# –î–æ–¥–∞—î–º–æ –≤—Å—ñ .md.age —Ñ–∞–π–ª–∏
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ find –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ –∑–±–æ—Ä—É .md.age —Ñ–∞–π–ª—ñ–≤ –∑ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
# find . -maxdepth 1 -name '*.md.age' -print0 | xargs -0 -I {} FILES_TO_ARCHIVE+=("{}") # –ù–µ –∑–æ–≤—Å—ñ–º —Ç–∞–∫ –¥–ª—è –º–∞—Å–∏–≤—ñ–≤
# –ö—Ä–∞—â–µ —Ç–∞–∫:
while IFS= read -r -d $'\0' file; do
  FILES_TO_ARCHIVE+=("${file#./}") # –í–∏–¥–∞–ª—è—î–º–æ –º–æ–∂–ª–∏–≤–∏–π ./ –Ω–∞ –ø–æ—á–∞—Ç–∫—É
done < <(find . -maxdepth 1 -type f -name "*.md.age" -print0)

# –î–æ–¥–∞—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é .git, —è–∫—â–æ –≤–æ–Ω–∞ —ñ—Å–Ω—É—î (–≤–∞–∂–ª–∏–≤–æ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –±–µ–∫–∞–ø—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é)
[ -d ".git" ] && FILES_TO_ARCHIVE+=(".git")

if [ ${#FILES_TO_ARCHIVE[@]} -eq 0 ]; then
    echo "[‚ö†Ô∏è] –ù–µ–º–∞—î —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è (README.md, *.md.age, .git). –ü—Ä–æ–ø—É—Å–∫–∞—é —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É."
    exit 0
fi
echo "[‚ÑπÔ∏è] –§–∞–π–ª–∏ –¥–ª—è –∞—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è: ${FILES_TO_ARCHIVE[*]}"


echo "[üì¶] –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö—ñ–≤—É: $LOCAL_TAR_ARCHIVE_PATH..."
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ --transform –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö './' —è–∫—â–æ –≤–æ–Ω–∏ —î, —Ç–∞ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–æ—ó —á–∏—Å—Ç–æ—Ç–∏
# tar -czf "$LOCAL_TAR_ARCHIVE_PATH" --transform='s|^\./||g' "${FILES_TO_ARCHIVE[@]}"
# –ê–±–æ, —è–∫—â–æ –º–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —à–ª—è—Ö–∏ —á–∏—Å—Ç—ñ (–±–µ–∑ ./), —Ç–æ –ø—Ä–æ—Å—Ç–æ:
if tar czf "$LOCAL_TAR_ARCHIVE_PATH" "${FILES_TO_ARCHIVE[@]}"; then
  echo "[‚úÖ] –õ–æ–∫–∞–ª—å–Ω–∏–π –∞—Ä—Ö—ñ–≤ '$LOCAL_TAR_ARCHIVE_PATH' —Å—Ç–≤–æ—Ä–µ–Ω–æ."
else
  echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö—ñ–≤—É '$LOCAL_TAR_ARCHIVE_PATH'."
  [ -f "$LOCAL_TAR_ARCHIVE_PATH" ] && rm -f "$LOCAL_TAR_ARCHIVE_PATH"
  exit 1
fi

echo "[üîê] –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é age: $LOCAL_ENCRYPTED_ARCHIVE_PATH..."
if age -r "$AGE_RECIPIENT" -o "$LOCAL_ENCRYPTED_ARCHIVE_PATH" "$LOCAL_TAR_ARCHIVE_PATH"; then
  echo "[‚úÖ] –ê—Ä—Ö—ñ–≤ '$LOCAL_ENCRYPTED_ARCHIVE_PATH' —É—Å–ø—ñ—à–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ."
else
  echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É '$LOCAL_TAR_ARCHIVE_PATH'."
  [ -f "$LOCAL_ENCRYPTED_ARCHIVE_PATH" ] && rm -f "$LOCAL_ENCRYPTED_ARCHIVE_PATH"
  [ -f "$LOCAL_TAR_ARCHIVE_PATH" ] && rm -f "$LOCAL_TAR_ARCHIVE_PATH" # –¢–∞–∫–æ–∂ –≤–∏–¥–∞–ª—è—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π tar
  exit 1
fi

echo "[üóëÔ∏è] –ë–µ–∑–ø–µ—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö—ñ–≤—É '$LOCAL_TAR_ARCHIVE_PATH'..."
if shred -u "$LOCAL_TAR_ARCHIVE_PATH"; then
  echo "[‚úÖ] –ù–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∞—Ä—Ö—ñ–≤ –≤–∏–¥–∞–ª–µ–Ω–æ."
else
  echo "[‚ùå] –ü–æ–º–∏–ª–∫–∞ –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è '$LOCAL_TAR_ARCHIVE_PATH'! –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–¥–∞–ª—ñ—Ç—å –π–æ–≥–æ –≤—Ä—É—á–Ω—É —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ."
  # –ù–µ –≤–∏—Ö–æ–¥–∏–º–æ, –±–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∞—Ä—Ö—ñ–≤ –≤–∂–µ —î, –∞–ª–µ —Ü–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
fi

# –†–æ–∑–±–∏–≤–∞—î–º–æ CLOUD_REMOTES –Ω–∞ –º–∞—Å–∏–≤
IFS=' ' read -r -a REMOTES_ARRAY <<< "$CLOUD_REMOTES"

UPLOAD_SUCCESS_COUNT=0
UPLOAD_FAIL_COUNT=0

echo "[‚òÅÔ∏è] –ü–æ—á–∞—Ç–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Ö–º–∞—Ä–Ω—ñ —Å—Ö–æ–≤–∏—â–∞..."
for remote_target in "${REMOTES_ARRAY[@]}"; do
  # remote_target –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ—Å—Ç–æ "myremote:" –∞–±–æ "myremote:path/to/dir"
  # rclone copy source remote:destination_path
  echo "    [üöÄ] –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è '$LOCAL_ENCRYPTED_ARCHIVE_PATH' –Ω–∞ '$remote_target'..."
  if rclone copy "$LOCAL_ENCRYPTED_ARCHIVE_PATH" "$remote_target" --progress; then
    echo "    [‚úÖ] –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –Ω–∞ $remote_target."
    ((UPLOAD_SUCCESS_COUNT++))
  else
    echo "    [‚ùå] –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ $remote_target."
    ((UPLOAD_FAIL_COUNT++))
  fi
done

echo ""
echo "[üìä] –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∫–∞–ø—ñ–≤ –Ω–∞ —Ö–º–∞—Ä–Ω—ñ —Å—Ö–æ–≤–∏—â–∞:"
echo "    –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –Ω–∞: $UPLOAD_SUCCESS_COUNT —Å—Ö–æ–≤–∏—â."
if [ $UPLOAD_FAIL_COUNT -gt 0 ]; then
  echo "    [‚ùó] –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞: $UPLOAD_FAIL_COUNT —Å—Ö–æ–≤–∏—â."
  echo "        –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è rclone —Ç–∞ –¥–æ—Å—Ç—É–ø –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö remote."
fi

if [ $UPLOAD_SUCCESS_COUNT -gt 0 ] && [ $UPLOAD_FAIL_COUNT -eq 0 ]; then
    echo "[üëç] –†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –Ω–∞ –≤—Å—ñ —Ö–º–∞—Ä–Ω—ñ —Å—Ö–æ–≤–∏—â–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ."
elif [ $UPLOAD_SUCCESS_COUNT -gt 0 ]; then
    echo "[üëç] –†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –Ω–∞ —Ö–º–∞—Ä—É —á–∞—Å—Ç–∫–æ–≤–æ —É—Å–ø—ñ—à–Ω–µ (–Ω–∞ $UPLOAD_SUCCESS_COUNT –∑ ${#REMOTES_ARRAY[@]} —Å—Ö–æ–≤–∏—â)."
else
    echo "[üëé] –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±–µ–∫–∞–ø –Ω–∞ –∂–æ–¥–Ω–µ —Ö–º–∞—Ä–Ω–µ —Å—Ö–æ–≤–∏—â–µ."
    if [ ${#REMOTES_ARRAY[@]} -gt 0 ]; then # –Ø–∫—â–æ –±—É–ª–∏ —Å–∫–æ–Ω—Ñ—ñ–≥—É—Ä–æ–≤–∞–Ω—ñ —Ä–µ–º–æ—É—Ç–∏
        exit 1 # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ –∂–æ–¥–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è
    fi
fi

# –õ–æ–∫–∞–ª—å–Ω–∏–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –±–µ–∫–∞–ø –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ –ø–∞–ø—Ü—ñ backup/.
echo "[‚ÑπÔ∏è] –õ–æ–∫–∞–ª—å–Ω–∏–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –±–µ–∫–∞–ø –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤: $LOCAL_ENCRYPTED_ARCHIVE_PATH"